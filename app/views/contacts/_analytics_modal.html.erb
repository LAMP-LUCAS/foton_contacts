<%= turbo_frame_tag "modal" do %>
  <%# app/views/contacts/_analytics_modal.html.erb %>
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="analysisModalLabel">
          <i class="bi bi-graph-up"></i> <%= l(:label_foton_contacts_individual_analysis) %> - <%= contact.name %>
        </h5>
        <%= link_to "&#10006;".html_safe, close_modal_contacts_path, class: "btn-close", "aria-label": "Close", data: { "turbo-method": :post } %>
      </div>
      <div class="modal-body">
        <% if @contact.person? && @irpa_data %>
          <!-- IRPA Score -->
          <div class="row mb-4">
            <div class="col-md-8">
              <div class="card">
                <div class="card-body">
                  <h3 class="risk-high">IRPA: <%= @irpa_data[:risk_score] %>
                    <span class="badge bg-danger"><%= l(:label_foton_contacts_high_risk) %></span> <%# TODO: Dynamic risk level %>
                  </h3>
                  <p class="text-muted"><%= l(:label_foton_contacts_irpa_description) %></p>
                  
                  <div class="row mt-4">
                    <div class="col-md-4">
                      <div class="kpi-card">
                        <div class="kpi-value risk-high"><%= number_to_percentage(@irpa_data[:tah_percent], precision: 0) %></div>
                        <div class="kpi-label"><%= l(:label_foton_contacts_historical_delay_rate) %></div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="kpi-card">
                        <div class="kpi-value risk-high"><%= number_to_percentage(@irpa_data[:ir_percent], precision: 0) %></div>
                        <div class="kpi-label"><%= l(:label_foton_contacts_rework_index) %></div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="kpi-card">
                        <div class="kpi-value risk-medium"><%= @irpa_data[:fcp_avg].round(1) %></div>
                        <div class="kpi-label"><%= l(:label_foton_contacts_criticality_factor) %></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0"><%= l(:label_recommendations) %></h6>
                </div>
                <div class="card-body">
                  <ul class="list-unstyled">
                    <li class="mb-2"><i class="bi bi-exclamation-triangle text-warning"></i> <%= l(:recommendation_avoid_critical_tasks) %></li>
                    <li class="mb-2"><i class="bi bi-people text-primary"></i> <%= l(:recommendation_consider_pair_work) %></li>
                    <li class="mb-2"><i class="bi bi-clock-history text-info"></i> <%= l(:recommendation_frequent_review) %></li>
                    <li><i class="bi bi-award text-success"></i> <%= l(:recommendation_offer_training) %></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- Career History & Performance -->
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0"><%= l(:label_contact_employments) %></h6>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th><%= l(:field_company) %></th>
                          <th><%= l(:field_position) %></th>
                          <th><%= l(:label_period) %></th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if @employments.any? %>
                          <% @employments.each do |employment| %>
                            <tr>
                              <td><%= employment.company.name %></td>
                              <td><%= employment.position %></td>
                              <td><%= format_date(employment.start_date) %> - <%= employment.end_date ? format_date(employment.end_date) : l(:label_present) %></td>
                            </tr>
                          <% end %>
                        <% else %>
                          <tr>
                            <td colspan="3"><%= l(:label_no_career_history_for_contact) %></td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0"><%= l(:label_foton_contacts_recent_project_performance) %></h6>
                </div>
                <div class="card-body">
                  <%# As a first step, showing a list of recent closed issues instead of a chart %>
                  <ul class="list-group list-group-flush">
                    <% if @recent_performance_issues.any? %>
                      <% @recent_performance_issues.each do |issue| %>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          <%= link_to issue.subject, issue_path(issue) %>
                          <span class="badge bg-<%= issue.due_date && issue.closed_on.to_date > issue.due_date ? 'danger' : 'success' %>">
                            <%= issue.due_date && issue.closed_on.to_date > issue.due_date ? l(:label_issue_status_late) : l(:label_done) %>
                          </span>
                        </li>
                      <% end %>
                    <% else %>
                      <li class="list-group-item"><%= l(:label_no_data) %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- Current Workload -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0"><%= l(:label_foton_contacts_current_workload) %></h6>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th><%= l(:field_project) %></th>
                          <th><%= l(:field_issue) %></th>
                          <th><%= l(:field_priority) %></th>
                          <th><%= l(:field_due_date) %></th>
                          <th><%= l(:field_status) %></th>
                          <%# The 'Allocation' column from the mockup requires more complex logic from workload_query.rb, omitted for now. %>
                        </tr>
                      </thead>
                      <tbody>
                        <% if @current_workload.any? %>
                          <% @current_workload.each do |issue| %>
                            <tr>
                              <td><%= link_to_project(issue.project) %></td>
                              <td><%= link_to issue.subject, issue_path(issue) %></td>
                              <td><%= issue.priority.name %></td>
                              <td><%= format_date(issue.due_date) %></td>
                              <td><%= issue.status.name %></td>
                            </tr>
                          <% end %>
                        <% else %>
                          <tr>
                            <td colspan="5"><%= l(:label_no_issues_for_contact) %></td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% else %>
          <%# Placeholder for companies or contacts without data %>
          <div class="empty-state">
            <p class="empty-state__message"><%= l(:label_no_data_for_period) %></p>
          </div>
        <% end %>
      </div>
      <div class="modal-footer">
        <%= link_to l(:button_close), close_modal_contacts_path, class: "btn btn-secondary fw-bold text-white", data: { "turbo-method": :post } %>
        <%= link_to l(:button_edit), edit_contact_path(contact), class: "btn btn-primary fw-bold text-white", data: { turbo_frame: "modal" } %>
      </div>
    </div>
  </div>
<% end %>