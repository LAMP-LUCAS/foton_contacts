<div class="contextual">
  <%= link_to l(:button_edit), edit_contact_path(@contact), class: 'icon icon-edit' if User.current.allowed_to?(:manage_contacts, @project, global: true) %>
  <%= delete_link contact_path(@contact) if User.current.allowed_to?(:manage_contacts, @project, global: true) %>
</div>

<h2><%= @contact.name %></h2>

<%# Principal Details %>
<div class="box">
  <p><strong><%= l(:field_type) %>:</strong> <%= l("label_#{@contact.contact_type}") %></p>
  <p><strong><%= l(:field_status) %>:</strong> <%= l("label_#{@contact.status}") %></p>
  <p><strong><%= l(:field_email) %>:</strong> <%= @contact.email %></p>
  <p><strong><%= l(:field_phone) %>:</strong> <%= @contact.phone %></p>
  <p><strong><%= l(:field_address) %>:</strong> <%= simple_format(@contact.address) %></p>
  <p><strong><%= l(:field_description) %>:</strong> <%= simple_format(@contact.description) %></p>
  <hr/>
  <p><strong><%= l(:field_author) %>:</strong> <%= link_to_user @contact.author %></p>
  <p><strong><%= l(:field_created_on) %>:</strong> <%= format_time(@contact.created_at) %></p>
  <p><strong><%= l(:field_is_private) %>:</strong> <%= @contact.is_private? ? l(:general_text_yes) : l(:general_text_no) %></p>
  <% if @contact.project %>
    <p><strong><%= l(:field_project) %>:</strong> <%= link_to_project @contact.project %></p>
  <% end %>
</div>

<%# Custom Fields %>
<% if @custom_values.any? %>
  <div class="box">
    <h3><%= l(:label_custom_fields) %></h3>
    <%= render_custom_fields_rows(@contact) %>
  </div>
<% end %>

<%# Companies a person belongs to %>
<% if @contact.person? && @contact_roles.present? %>
<div class="box">
  <h3><%= l(:label_companies) %></h3>
  <table class="list">
    <thead>
      <tr>
        <th><%= l(:label_company) %></th>
        <th><%= l(:field_position) %></th>
        <th><%= l(:field_status) %></th>
      </tr>
    </thead>
    <tbody>
      <% @contact_roles.each do |role| %>
        <tr class="contact-role">
          <td><%= link_to role.company.name, contact_path(role.company) %></td>
          <td><%= role.position %></td>
          <td><span class="status <%= role.status %>"><%= l("label_#{role.status}") %></span></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
<% end %>

<%# Career History %>
<% if @contact.person? && @contact_employments.present? %>
<div class="box">
  <h3><%= l(:label_career_history) %></h3>
  <table class="list">
    <thead>
      <tr>
        <th><%= l(:label_company) %></th>
        <th><%= l(:field_position) %></th>
        <th><%= l(:label_period) %></th>
      </tr>
    </thead>
    <tbody>
      <% @contact_employments.each do |employment| %>
        <tr>
          <td><%= link_to employment.company.name, contact_path(employment.company) %></td>
          <td><%= employment.position %></td>
          <td><%= format_date(employment.start_date) %> - <%= employment.end_date ? format_date(employment.end_date) : l(:label_present) %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
<% end %>

<%# Employees List %>
<% if !@contact.person? && @employees.present? %>
<div class="box">
  <h3><%= l(:label_employees) %></h3>
  <table class="list">
    <thead>
      <tr>
        <th><%= l(:label_employee) %></th>
        <th><%= l(:field_position) %></th>
        <th><%= l(:field_status) %></th>
      </tr>
    </thead>
    <tbody>
      <% @employees.each do |role| %>
        <tr class="contact-role">
          <td><%= link_to role.person.name, contact_path(role.person) %></td>
          <td><%= role.position %></td>
          <td><span class="status <%= role.status %>"><%= l("label_#{role.status}") %></span></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
<% end %>

<%# Groups %>
<% if @contact_groups.present? %>
<div class="box">
  <h3><%= l(:label_groups) %></h3>
  <ul class="contact-groups">
    <% @contact_groups.each do |group| %>
      <li><%= link_to group.name, contact_group_path(group) %></li>
    <% end %>
  </ul>
</div>
<% end %>

<%# Associated Issues %>
<% if @issues.present? %>
<div class="box">
  <h3><%= l(:label_issues) %></h3>
  <%= render partial: 'issues/list_simple', locals: { issues: @issues } %>
</div>
<% end %>

<%# History %>
<% if @journals.present? %>
<div class="box">
  <h3><%= l(:label_history) %></h3>
  <%= render_journals(@journals) %>
</div>
<% end %>

<%# Analytics %>
<div id="analytics-container" class="box">
  <%= render partial: 'analytics_modal' %>
</div>


<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'contacts', plugin: 'foton_contacts' %>
<% end %>

<%# JavaScript to fix the analytics tabs %>
<script type="text/javascript">
$(document).ready(function(){
  // Use the new ID for the container
  var analyticsContainer = $('#analytics-container'); 

  // The default Redmine tab handler is too broad.
  // We stop it from acting on our analytics tabs and provide our own logic.
  analyticsContainer.find('.tabs a').off('click').on('click', function(e){
    e.preventDefault();
    e.stopPropagation(); // Prevent Redmine's global handler from running

    var clickedLink = $(this);
    var tabContainer = clickedLink.closest('.tabs');
    var analyticsBox = clickedLink.closest('#analytics-container'); // The scope of our tabs
    var tabId = clickedLink.attr('href');

    // Update 'selected' class on tabs
    tabContainer.find('a').removeClass('selected');
    clickedLink.addClass('selected');

    // Show/hide the correct tab content *within the analytics box*
    analyticsBox.find('.tab-content').hide();
    analyticsBox.find(tabId).show();
  });
});
</script>
